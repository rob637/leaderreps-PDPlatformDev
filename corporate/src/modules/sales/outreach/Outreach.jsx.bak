import React, { useState, useEffect } from 'react';
import { 
  Send, Calendar, MessageSquare, Phone, CheckCircle, Clock, 
  AlertCircle, ChevronRight, Play, Pause, MoreHorizontal, 
  Mail, Linkedin, Ticket, ArrowRight, BarChart2, Users, X,
  Lightbulb, Shield, Zap
} from 'lucide-react';
import { collection, query, where, getDocs, updateDoc, doc, addDoc } from 'firebase/firestore';
import { db } from '../../../firebase';

const Outreach = () => {
  const [activeTab, setActiveTab] = useState('tasks');
  const [loading, setLoading] = useState(true);
  const [tasks, setTasks] = useState([]);
  const [selectedTask, setSelectedTask] = useState(null); // For the modal
  const [showComposer, setShowComposer] = useState(false);

  // --- PSYCHOLOGY & CAMPAIGN DATA ---
  const CAMPAIGNS = {
    'c1': {
        id: 'c1',
        name: 'The "Trojan Horse" Workshop',
        description: 'Invite HR/Sales leaders to a free "Leader Circle" session to demonstrate value before selling.',
        stats: { openRate: '68%', replyRate: '24%', meetings: 12 },
        active: true,
        steps: [
            { 
                day: 0, 
                type: 'email', 
                label: 'value-invite', 
                name: 'Private Invite: Leader Circle',
                subject: "Invitation: Private Leader Circle for [Company]",
                template: "Hi [First Name],\n\nI'm hosting a private 'Leader Circle' session on [Date] focusing on [Topic]. \n\nWe're curating a small group of 5-6 leaders from similar sized companies to share what's actually working in 2024. No pitch, just peer learning.\n\nI'd love to have your perspective from [Company] in the room.\n\nOpen to it?",
                psychology: {
                    principle: "The 'No Ask' Invitation",
                    why: "By framing this as a peer-learning event rather than a sales call, you lower defenses. Using 'Private' and 'Curated' triggers exclusivity."
                }
            },
            { 
                day: 3, 
                type: 'linkedin', 
                label: 'connect', 
                name: 'Connect + Mention Invite',
                template: "Hi [First Name], sent you an invite to the Leader Circle earlier. Would love to connect here regardless.",
                psychology: {
                    principle: "The 'Omnichanne' Nudge",
                    why: "Seeing your name in two places (Inbox + LinkedIn) increases familiarity. The request is low-friction."
                }
            },
            { 
                day: 7, 
                type: 'email', 
                label: 'value-asset', 
                name: 'Send "Culture Audit" PDF',
                subject: "Thought you might like this (Culture Audit)",
                template: "Hi [First Name],\n\nSince you're busy, I thought I'd send over the 'Culture Audit' framework we'll be discussing.\n\nIt takes about 3 minutes to run through and usually highlights the #1 gap in retention strategies.\n\n[Link]\n\nHope it's helpful.",
                psychology: {
                    principle: "The Law of Reciprocity",
                    why: "Giving value (the Audit framework) without asking for anything in return creates a psychological debt. You are demonstrating expertise, not claiming it."
                }
            },
            { 
                day: 12, 
                type: 'call', 
                label: 'call', 
                name: 'Brief 5-min intro',
                script: "Hi [First Name], just calling to see if that Culture Audit was useful. No worries if not, just wanted to close the loop.",
                psychology: {
                    principle: "The 'Close the Loop' Call",
                    why: "This isn't a cold call; it's a follow-up on value provided. It changes the frame from 'Stranger' to 'Helpful Consultant'."
                }
            }
        ]
    },
    'c2': {
        id: 'c2',
        name: 'Founder-to-Founder',
        description: 'Direct high-level outreach from Rob to other CEOs/Founders.',
        active: true,
        steps: [
            { day: 0, type: 'linkedin', name: 'Founder Connection' },
            { day: 2, type: 'email', name: 'Quick question' },
            { day: 5, type: 'video', name: '30s personal Loom video' }
        ]
    }
  };

  useEffect(() => {
    loadTasks();
  }, []);

  const loadTasks = async () => {
    try {
        const q = query(collection(db, 'corporate_prospects'), where('status', '==', 'sequence_active'));
        const snapshot = await getDocs(q);
        const fetchedTasks = snapshot.docs.map(d => {
            const data = d.data();
            // Default to Campaign 1 if missing or invalid
            const campaignId = data.campaignId && CAMPAIGNS[data.campaignId] ? data.campaignId : 'c1';
            const campaign = CAMPAIGNS[campaignId];
            
            // Determine current step index
            const stepIndex = data.currentStepIndex || 0;
            const step = campaign.steps[stepIndex] || campaign.steps[0];
            
            // Determine due date status
            // In a real app, compare data.nextTaskDate with today
            const isToday = true; // Simulating everything is due today for demo

            return {
                id: d.id,
                prospect: data.name,
                company: data.company,
                title: data.title || 'Leader',
                type: step.type,
                subject: step.name, // Display name for the list
                campaignId: campaignId,
                stepIndex: stepIndex,
                stepData: step,
                due: isToday ? 'Today' : data.nextTaskDate,
                status: 'pending'
            };
        });
        
        setTasks(fetchedTasks);
    } catch (e) {
        console.error("Error loading tasks", e);
    } finally {
        setLoading(false);
    }
  };

  const handleTaskClick = (task) => {
    setSelectedTask(task);
    setShowComposer(true);
  };

  const advanceSequence = async (task) => {
      // 1. Calculate next step
      const campaign = CAMPAIGNS[task.campaignId];
      const nextIndex = task.stepIndex + 1;
      
      // Remove from local list immediately for UI responsiveness
      setTasks(prev => prev.filter(t => t.id !== task.id));
      setShowComposer(false);

      if (nextIndex < campaign.steps.length) {
          // Has next step
          const nextStep = campaign.steps[nextIndex];
          const currentStep = campaign.steps[task.stepIndex];
          
          // Calculate delay
          const dayDiff = nextStep.day - currentStep.day;
          
          // In real app: nextDate = moment().add(dayDiff, 'days')
          
          if (typeof task.id === 'string' && task.id.length > 5) {
             await updateDoc(doc(db, 'corporate_prospects', task.id), {
                 currentStepIndex: nextIndex,
                 nextTaskDate: new Date(Date.now() + (dayDiff * 86400000)).toISOString(),
                 nextTaskType: nextStep.type,
                 lastContacted: new Date().toISOString(),
                 history: [
                    ...(task.history || []), 
                    { date: new Date().toISOString(), action: `Completed Step ${task.stepIndex}: ${currentStep.name}` }
                 ]
             });
          }
      } else {
          // Sequence Complete
          if (typeof task.id === 'string' && task.id.length > 5) {
            await updateDoc(doc(db, 'corporate_prospects', task.id), {
                status: 'sequence_completed',
                lastContacted: new Date().toISOString()
            });
         }
      }
  };

  return (
    <div className="p-8 relative min-h-screen">
      {/* Header */}
      <div className="flex items-center justify-between mb-8">
        <div>
          <h1 className="text-2xl font-bold text-corporate-navy">Outreach Engine</h1>
          <p className="text-slate-500 mt-1">Multi-channel engagement sequences to turn prospects into partners</p>
        </div>
        <div className="flex items-center gap-3">
           {/* Add Campaign implementation later */}
        </div>
      </div>

       {/* KPIs Row */}
       <div className="grid grid-cols-4 gap-4 mb-8">
          <KPICard title="Active Prospects" value={tasks.length + 124} icon={Users} color="blue" sub="Total In Sequence" />
          <KPICard title="Open Rate" value="68%" icon={Mail} color="purple" sub="Avg across campaigns" />
          <KPICard title="Meetings Booked" value="12" icon={Calendar} color="teal" sub="This Month" />
          <KPICard title="Tasks Due" value={tasks.length} icon={CheckCircle} color="amber" sub="Needs Attention" />
      </div>

      {/* Tabs */}
      <div className="border-b border-slate-200 mb-6">
        <div className="flex gap-6">
          <button
            onClick={() => setActiveTab('tasks')}
            className={`pb-3 text-sm font-medium border-b-2 transition ${
              activeTab === 'tasks' ? 'border-corporate-teal text-corporate-teal' : 'border-transparent text-slate-500 hover:text-slate-700'
            }`}
          >
            Daily Tasks 
            {tasks.length > 0 && <span className="ml-2 bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full text-xs">{tasks.length}</span>}
          </button>
          <button
            onClick={() => setActiveTab('campaigns')}
            className={`pb-3 text-sm font-medium border-b-2 transition ${
              activeTab === 'campaigns' ? 'border-corporate-teal text-corporate-teal' : 'border-transparent text-slate-500 hover:text-slate-700'
            }`}
          >
            Review Strategy
          </button>
        </div>
      </div>

      {/* TASKS VIEW */}
      {activeTab === 'tasks' && (
        <div className="bg-white border border-slate-200 rounded-xl overflow-hidden min-h-[400px]">
           <div className="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
              <h3 className="font-semibold text-corporate-navy">Today's Executions</h3>
              <div className="flex gap-2 text-sm">
                 <button className="text-slate-500 hover:text-slate-700 px-2 py-1">Filter by type</button>
              </div>
           </div>
           
           {tasks.length === 0 && !loading ? (
               <div className="flex flex-col items-center justify-center p-12 text-center h-full">
                    <div className="w-16 h-16 bg-green-50 rounded-full flex items-center justify-center mb-4 text-green-500">
                        <CheckCircle size={32} />
                    </div>
                    <h3 className="text-lg font-bold text-corporate-navy">All Caught Up!</h3>
                    <p className="text-slate-500">You've cleared your outreach queue for today.</p>
               </div>
           ) : (
                <div className="divide-y divide-slate-100">
                    {tasks.map(task => (
                        <div key={task.id} className="p-4 hover:bg-slate-50 flex items-center gap-4 transition group cursor-pointer" onClick={() => handleTaskClick(task)}>
                            <div className={`w-10 h-10 rounded-full flex items-center justify-center shrink-0 ${
                            task.type === 'email' ? 'bg-purple-100 text-purple-600' :
                            task.type === 'linkedin' ? 'bg-blue-100 text-blue-600' :
                            'bg-green-100 text-green-600'
                            }`}>
                            {task.type === 'email' && <Mail size={18} />}
                            {task.type === 'linkedin' && <Linkedin size={18} />}
                            {task.type === 'call' && <Phone size={18} />}
                            </div>
                            <div className="flex-1">
                                <div className="flex items-center gap-2 mb-1">
                                    <span className="font-medium text-corporate-navy">{task.prospect}</span>
                                    <span className="text-slate-400 text-sm">â€¢ {task.company}</span>
                                    <span className="text-xs bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full border border-slate-200">
                                        Step {task.stepIndex + 1}
                                    </span>
                                </div>
                                <p className="text-sm text-slate-600">{task.subject}</p>
                            </div>
                            <div className="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button className="bg-corporate-teal text-white px-3 py-1.5 rounded-lg text-sm hover:bg-corporate-teal/90 flex items-center gap-2 shadow-sm">
                                    Execute <ArrowRight size={14} />
                                </button>
                            </div>
                        </div>
                    ))}
                </div>
           )}
        </div>
      )}

      {/* CAMPAIGNS VIEW */}
      {activeTab === 'campaigns' && (
         <div className="grid grid-cols-1 gap-6">
            {Object.values(CAMPAIGNS).map(campaign => (
               <CampaignCard key={campaign.id} campaign={campaign} />
            ))}
         </div>
      )}

      {/* EMAIL COMPOSER MODAL */}
      {showComposer && selectedTask && (
        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
            <div className="bg-white w-full max-w-4xl rounded-2xl shadow-2xl flex overflow-hidden max-h-[90vh]">
                {/* Left: Composer */}
                <div className="flex-1 flex flex-col border-r border-slate-200">
                    <div className="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                        <div className="flex items-center gap-3">
                            <div className={`w-8 h-8 rounded-full flex items-center justify-center ${
                                selectedTask.type === 'email' ? 'bg-purple-100 text-purple-600' : 'bg-blue-100 text-blue-600'
                            }`}>
                                {selectedTask.type === 'email' ? <Mail size={16} /> : <Linkedin size={16} />}
                            </div>
                            <div>
                                <h3 className="font-bold text-corporate-navy">Contacting {selectedTask.prospect}</h3>
                                <p className="text-xs text-slate-500">{selectedTask.title} at {selectedTask.company}</p>
                            </div>
                        </div>
                        <button onClick={() => setShowComposer(false)} className="text-slate-400 hover:text-slate-600">
                            <X size={20} />
                        </button>
                    </div>
                    
                    <div className="flex-1 p-6 overflow-y-auto">
                        <div className="mb-4">
                            <label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Subject</label>
                            <input 
                                type="text" 
                                className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm font-medium focus:ring-2 focus:ring-corporate-teal focus:border-transparent outline-none"
                                defaultValue={selectedTask.stepData.subject || ''}
                            />
                        </div>
                        <div className="h-full flex flex-col">
                            <label className="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Message</label>
                            <textarea 
                                className="w-full flex-1 border border-slate-300 rounded-lg px-3 py-3 text-sm font-normal text-slate-700 leading-relaxed focus:ring-2 focus:ring-corporate-teal focus:border-transparent outline-none resize-none font-sans"
                                defaultValue={
                                    (selectedTask.stepData.template || '')
                                    .replace('[First Name]', selectedTask.prospect.split(' ')[0])
                                    .replace('[Company]', selectedTask.company)
                                    .replace('[Date]', 'Thursday')
                                }
                            />
                        </div>
                    </div>

                    <div className="p-4 border-t border-slate-200 bg-slate-50 flex justify-between items-center">
                        <button className="text-slate-500 text-sm hover:text-slate-700 font-medium">
                            Save as Draft
                        </button>
                        <div className="flex gap-3">
                            <button onClick={() => setShowComposer(false)} className="px-4 py-2 text-slate-600 font-medium hover:bg-slate-200 rounded-lg transition">
                                Cancel
                            </button>
                            <button 
                                onClick={() => advanceSequence(selectedTask)}
                                className="bg-corporate-teal text-white px-6 py-2 rounded-lg font-bold shadow-md hover:shadow-lg hover:bg-corporate-teal/90 transition flex items-center gap-2"
                            >
                                <Send size={16} /> Send & Advance
                            </button>
                        </div>
                    </div>
                </div>

                {/* Right: Psychology / Context Pane */}
                <div className="w-80 bg-slate-50 flex flex-col">
                    <div className="p-4 border-b border-slate-200">
                        <h4 className="font-bold text-corporate-navy flex items-center gap-2">
                            <Lightbulb size={16} className="text-amber-500" />
                            Strategy Insight
                        </h4>
                    </div>
                    <div className="p-6 flex-1 overflow-y-auto">
                        {selectedTask.stepData.psychology ? (
                            <>
                                <div className="mb-6">
                                    <div className="text-xs font-bold text-slate-400 uppercase tracking-wide mb-2">Applied Principle</div>
                                    <div className="bg-white border border-slate-200 rounded-lg p-3 shadow-sm">
                                        <h5 className="font-bold text-corporate-navy text-sm mb-1">{selectedTask.stepData.psychology.principle}</h5>
                                    </div>
                                </div>
                                <div className="mb-6">
                                    <div className="text-xs font-bold text-slate-400 uppercase tracking-wide mb-2">Why It Works</div>
                                    <p className="text-sm text-slate-600 leading-relaxed">
                                        {selectedTask.stepData.psychology.why}
                                    </p>
                                </div>
                            </>
                        ) : (
                            <div className="text-center text-slate-400 mt-10">
                                <Shield size={32} className="mx-auto mb-2 opacity-50" />
                                <p className="text-sm">Standard communication step.</p>
                            </div>
                        )}

                        <div className="mt-8 pt-6 border-t border-slate-200">
                            <div className="text-xs font-bold text-slate-400 uppercase tracking-wide mb-3">Prospect Context</div>
                            <div className="space-y-3">
                                <div className="text-xs text-slate-500">
                                    <span className="block font-bold text-corporate-navy mb-0.5">Role</span>
                                    {selectedTask.title}
                                </div>
                                <div className="text-xs text-slate-500">
                                    <span className="block font-bold text-corporate-navy mb-0.5">Company Size</span>
                                    Unknown Employee Count
                                </div>
                                <div className="text-xs text-slate-500">
                                    <span className="block font-bold text-corporate-navy mb-0.5">Sequenced Date</span>
                                    {new Date().toLocaleDateString()}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div className="p-4 bg-amber-50 border-t border-amber-100">
                        <div className="flex gap-3">
                            <Zap size={16} className="text-amber-600 shrink-0 mt-0.5" />
                            <p className="text-xs text-amber-800 leading-snug">
                                <strong>Pro Tip:</strong> Keep the subject line under 4 words. Short subjects have 24% higher open rates on mobile.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
      )}
    </div>
  );
};

// Helper Components
const KPICard = ({ title, value, icon: Icon, color, sub }) => (
    <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
        <div className="flex items-center justify-between mb-2">
           <span className="text-slate-500 text-xs font-medium uppercase tracking-wider">{title}</span>
           <Icon size={16} className={`text-${color}-500`} />
        </div>
        <div className="text-2xl font-bold text-corporate-navy">{value}</div>
        <div className="text-xs text-slate-400 mt-1">{sub}</div>
     </div>
);

const CampaignCard = ({ campaign }) => (
    <div className="bg-white rounded-xl border border-slate-200 p-6 shadow-sm hover:shadow-md transition">
        <div className="flex justify-between items-start mb-6">
            <div>
            <div className="flex items-center gap-3 mb-2">
                <h3 className="text-lg font-bold text-corporate-navy">{campaign.name}</h3>
                {campaign.active ? (
                    <span className="bg-green-100 text-green-700 text-xs px-2 py-0.5 rounded-full font-medium flex items-center gap-1">
                        <div className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse" /> Active
                    </span>
                ) : (
                    <span className="bg-slate-100 text-slate-500 text-xs px-2 py-0.5 rounded-full font-medium">Paused</span>
                )}
            </div>
            <p className="text-slate-600 max-w-2xl">{campaign.description}</p>
            </div>
            {campaign.stats && (
                <div className="flex gap-4 text-center">
                    <div>
                        <div className="text-xl font-bold text-corporate-navy">{campaign.stats.openRate}</div>
                        <div className="text-xs text-slate-400 uppercase tracking-wide">Open Rate</div>
                    </div>
                    <div>
                        <div className="text-xl font-bold text-corporate-navy">{campaign.stats.replyRate}</div>
                        <div className="text-xs text-slate-400 uppercase tracking-wide">Reply Rate</div>
                    </div>
                </div>
            )}
        </div>

        {/* Visual Timeline */}
        <div className="relative pt-4 pb-2">
            <div className="absolute top-1/2 left-0 w-full h-0.5 bg-slate-100 -translate-y-1/2 z-0" />
            <div className="flex justify-between relative z-10 w-full px-4">
            {campaign.steps.map((step, idx) => (
                <div key={idx} className="flex flex-col items-center group cursor-pointer relative">
                    <div className={`w-10 h-10 rounded-full border-2 flex items-center justify-center bg-white transition z-10 relative ${
                        step.type === 'email' ? 'border-purple-200 text-purple-600 group-hover:border-purple-400' :
                        step.type === 'linkedin' ? 'border-blue-200 text-blue-600 group-hover:border-blue-400' :
                        step.type === 'video' ? 'border-pink-200 text-pink-600 group-hover:border-pink-400' :
                        'border-green-200 text-green-600 group-hover:border-green-400'
                    }`}>
                        {step.type === 'email' && <Mail size={16} />}
                        {step.type === 'linkedin' && <Linkedin size={16} />}
                        {step.type === 'video' && <Play size={16} />}
                        {step.type === 'call' && <Phone size={16} />}
                    </div>
                    <div className="mt-3 text-center">
                        <div className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Day {step.day}</div>
                        <div className="text-xs font-medium text-corporate-navy bg-white px-2 py-0.5 rounded shadow-sm border border-slate-100">{step.name}</div>
                    </div>
                </div>
            ))}
            </div>
        </div>
        
        <div className="mt-8 flex justify-end gap-3">
            <button className="text-slate-500 hover:text-corporate-navy text-sm font-medium px-3 py-2">Edit Steps</button>
            <button className="bg-slate-100 text-corporate-navy hover:bg-slate-200 px-4 py-2 rounded-lg text-sm font-medium">Add Prospects</button>
        </div>
    </div>
);

function TrendingUp({ size = 24, className = "" }) {
    return (
        <svg 
            xmlns="http://www.w3.org/2000/svg" 
            width={size} 
            height={size} 
            viewBox="0 0 24 24" 
            fill="none" 
            stroke="currentColor" 
            strokeWidth="2" 
            strokeLinecap="round" 
            strokeLinejoin="round" 
            className={className}
        >
            <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
            <polyline points="17 6 23 6 23 12"></polyline>
        </svg>
    );
}

export default Outreach;
